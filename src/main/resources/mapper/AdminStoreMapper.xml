<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.HiMade.admin.mapper.AdminStoreMapper">

    <select id="getNoticeList" resultType="com.example.HiMade.admin.dto.storeNoticeDTO">
        select * from store_notice
    </select>

    <insert id="setNotice" parameterType="com.example.HiMade.admin.dto.storeNoticeDTO">
        INSERT INTO store_notice (
        notice_regdate,
        notice_content,
        notice_type,
        store_no,
        store_id
        ) VALUES (
        NOW(),
        #{noticeContent},
        #{noticeType},
        1,
        'store123'
        );
    </insert>


    <select id="loginCheck" resultType="com.example.HiMade.admin.dto.StoreRegistDTO">
        select * from store_admin
        where store_id = #{id} and store_pw = #{pw}
    </select>

    <select id="duplicatedId" resultType="Integer">
        select count(*) from store_admin
        where store_id = #{storeId}
    </select>

    <insert id="registStore" parameterType="com.example.HiMade.admin.dto.StoreRegistDTO" useGeneratedKeys="true" keyProperty="storeNo">
        insert into store_admin (
            store_id,
            store_pw,
            store_cate,
            store_name,
            store_master,
            manager_name,
            manager_phone,
            store_business_no,
            store_signup,
            store_status,
            zipcode,
            addr,
            addrdetail
        ) values (
            #{storeId},
            #{storePw},
            #{storeCate},
            #{storeName},
            #{storeMaster},
            #{managerName},
            #{managerPhone},
            #{storeBusinessNo},
            now(),
            '대기',
            #{zipcode},
            #{addr},
            #{addrdetail}
        )
        returning store_no as storeNo
    </insert>

    <insert id="insertDay" parameterType="com.example.HiMade.admin.dto.DayOffDay">
        insert into day_off_day(day_off_type, store_id, store_no, day_off_fix_status, day_off_day)
        values (#{dayOffType}, #{storeId}, #{storeNo}, #{dayOffFixStatus}, #{dayOffDay});
    </insert>

<!--  가게관리  -->
    <update id="updateStore" parameterType="com.example.HiMade.admin.dto.StoreRegistDTO">
        update store_admin
        set
            store_intro = #{storeIntro},
            store_notice = #{storeNotice},
            store_open_time = #{storeOpenTime},
            store_close_time = #{storeCloseTime},
            store_parking_yn = #{storeParkingYn},
            account_bank = #{accountBank},
            account_number = #{accountNumber},
            store_status = #{storeStatus}
        where store_id = #{storeId}
    </update>

    <insert id="addStoreSns" parameterType="com.example.HiMade.admin.dto.StoreSnsDTO">
        insert into store_sns_link
        values (#{snsLink}, #{snsName}, #{storeId}, #{storeNo})
    </insert>

    <update id="updateStoreSns" parameterType="com.example.HiMade.admin.dto.StoreSnsDTO">
        update store_sns_link
        set (sns_link = #{snsLink}, sns_name = #{snsName})
        where store_id = #{storeId} and store_no = #{storeNo}
    </update>

    <select id="getMyStore" resultMap="storeRegistResultMap">
        SELECT
        sa.*,
        sns.*
        FROM store_admin sa
        LEFT JOIN store_sns_link sns ON sa.store_no = sns.store_no
        WHERE sa.store_no = #{storeNo}
    </select>

    <resultMap id="storeRegistResultMap" type="com.example.HiMade.admin.dto.StoreRegistDTO">
        <result property="storeId" column="store_id"/>
        <result property="storeNo" column="store_no"/>
        <result property="storePw" column="store_pw"/>
        <result property="storeCate" column="store_cate"/>
        <result property="storeName" column="store_name"/>
        <result property="storeMaster" column="store_master"/>
        <result property="managerName" column="manager_name"/>
        <result property="managerPhone" column="manager_phone"/>
        <result property="zipcode" column="zipcode"/>
        <result property="addr" column="addr"/>
        <result property="addrdetail" column="addrdetail"/>
        <result property="storeBusinessNo" column="store_business_no"/>
        <result property="storeIntro" column="store_intro"/>
        <result property="storeParkingYn" column="store_parking_yn"/>
        <result property="storeNotice" column="store_notice"/>
        <result property="storeOpenTime" column="store_open_time"/>
        <result property="storeCloseTime" column="store_close_time"/>
        <result property="accountBank" column="account_bank"/>
        <result property="accountNumber" column="account_number"/>
        <result property="storeSignup" column="store_signup"/>
        <result property="storeStatus" column="store_status"/>

        <!-- SNS 매핑 -->
        <collection property="storeSns" ofType="com.example.HiMade.admin.dto.StoreSnsDTO">
            <result property="storeSnsNo" column="store_sns_no"/>
            <result property="snsLink" column="sns_link"/>
            <result property="snsName" column="sns_name"/>
            <result property="storeId" column="store_id"/>
            <result property="storeNo" column="store_no"/>
        </collection>
    </resultMap>

    <update id="updateDay" parameterType="com.example.HiMade.admin.dto.StoreRegistDTO">
        <!-- 휴무가 아닌 경우 상태를 'N'으로 업데이트 -->
        update day_off_day
        set day_off_fix_status = 'N'
        where store_id = #{storeId}
        and store_no = #{storeNo}
        and day_off_day NOT IN
        <foreach item="dayOffDay" collection="dayOffDayList" open="(" separator="," close=")">
            #{dayOffDay.dayOffDay}
        </foreach>;

        <!-- 휴무인 경우 상태를 'Y'로 업데이트 -->
        <foreach item="dayOffDay" collection="dayOffDayList">
            update day_off_day
            set day_off_fix_status = 'Y'
            where store_id = #{storeId}
            and store_no = #{storeNo}
            and day_off_day = #{dayOffDay.dayOffDay};
        </foreach>
    </update>

    <insert id="registDayOffSet" parameterType="com.example.HiMade.admin.dto.DayOffSet">
        insert into day_off_set(day_off_start, day_off_end, store_id, store_no)
        values(#{dayOffStart}, #{dayOffEnd}, #{storeId}, #{storeNo})
    </insert>


</mapper>
